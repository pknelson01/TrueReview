<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>

    <link rel="stylesheet" href="/public/css/layout.css" />
    <link rel="stylesheet" href="/public/css/dashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>

<nav class="navbar">
    <div class="nav-left">
        <a href="/dashboard" class="brand">TrueReview</a>
    </div>

    <div class="nav-center">
        <a href="/add-movie" class="add-movie-btn-nav">+ Add Movie</a>
    </div>

    <div class="nav-right">
        <a href="/dashboard">Home</a>
        <a href="/watched">Watched</a>
        <form action="/logout" method="POST" style="display:inline;">
            <button class="logout-btn">Logout</button>
        </form>
    </div>
</nav>

<div class="dashboard-container">

    <div class="content-card">

        <div class="profile-header bg-edit-zone">
        
            <!-- Background image -->
            <img id="background-img" class="background-img" style="display:none;" />
            <div id="background-placeholder" class="background-placeholder"></div>
        
            <!-- Hover overlay for background -->
            <div class="bg-edit-overlay" onclick="triggerFileInput('bg-input'); event.stopPropagation();">
                <i class="fa-solid fa-pencil"></i>
            </div>
        
            <!-- Hidden file input for background -->
            <input id="bg-input" type="file" accept="image/*" style="display:none;">
        
            <!-- PROFILE PIC -->
            <div class="profile-pic-wrapper pfp-edit-zone"
                 onclick="triggerFileInput('pfp-input'); event.stopPropagation();">
        
                <img id="profile-pic" class="profile-pic" style="display:none;" />
                <div id="profile-placeholder" class="profile-placeholder">?</div>
        
                <div class="edit-overlay">
                    <i class="fa-solid fa-pencil"></i>
                </div>
            
                <input id="pfp-input" type="file" accept="image/*" style="display:none;">
            </div>
        
        </div>

        
        
        
        <!-- END MOVED SECTION -->

        <!-- CONTENT SECTION BELOW BANNER -->
        <div class="profile-flex-row">

            <div class="profile-info">
                <h1 id="username" class="username"></h1>

                <p id="user-title" class="user-title" style="display:none;"></p>
                <p id="user-bio" class="user-bio" style="display:none;"></p>

                <div class="follow-stats">
                    <span><strong id="followerCount">0</strong> Followers</span>
                    <span class="divider">|</span>
                    <span><strong id="followingCount">0</strong> Following</span>
                </div>

                <div class="movie-stats">
                    <p id="stats-line">0 movies watched • Avg rating: N/A</p>
                </div>

                <p id="favorite-movie" class="favorite" style="display:none;">
                    Favorite Movie: <span id="favorite-title"></span>
                </p>
            </div>

            <div id="last-watched-container" class="last-watched" style="display:none;">
                <img id="last-poster" class="last-poster" />
                <h2 class="last-title">
                    <span id="last-title"></span>
                    <span class="rating-line">
                        you rated it <span id="last-rating"></span>/5
                    </span>
                </h2>
            </div>

        </div>

    </div> <!-- END CONTENT CARD -->

</div>

<script>
    async function loadDashboard() {
        const res = await fetch("/api/dashboard");
        const data = await res.json();

        const user = data.user;

        // Background
        if (user.profile_background_photo) {
            document.getElementById("background-img").src =
                "/uploads/profile_backgrounds/" + user.profile_background_photo;
            document.getElementById("background-img").style.display = "block";
            document.getElementById("background-placeholder").style.display = "none";
        }

        // Profile picture
        if (user.profile_picture) {
            document.getElementById("profile-pic").src =
                "/uploads/profile_pictures/" + user.profile_picture;
            document.getElementById("profile-pic").style.display = "block";
            document.getElementById("profile-placeholder").style.display = "none";
        }

        document.getElementById("username").textContent = user.username;
        if (user.title) {
            const t = document.getElementById("user-title");
            t.textContent = `"${user.title}"`;
            t.style.display = "block";
        }
        if (user.bio) {
            const b = document.getElementById("user-bio");
            b.textContent = user.bio;
            b.style.display = "block";
        }

        document.getElementById("followerCount").textContent = data.follower_count;
        document.getElementById("followingCount").textContent = data.following_count;

        document.getElementById("stats-line").textContent =
            `${data.total_movies} movies watched • Avg rating: ${data.avg_rating || "N/A"}`;

        if (data.favorite_movie_title) {
            document.getElementById("favorite-title").textContent = data.favorite_movie_title;
            document.getElementById("favorite-movie").style.display = "block";
        }

        if (data.last) {
            document.getElementById("last-poster").src = data.last.poster_full_url;
            document.getElementById("last-title").textContent = data.last.movie_title;
            document.getElementById("last-rating").textContent = data.last.user_rating;
            document.getElementById("last-watched-container").style.display = "block";
        }
    }

    loadDashboard();

    function triggerFileInput(id) {
        document.getElementById(id).click();
    }

    // ============================================================
    //     NEW CODE BELOW — THIS MAKES UPLOADS WORK
    // ============================================================

    // Upload new profile picture
    document.getElementById("pfp-input").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        await fetch("/api/upload/profile-picture", {
            method: "POST",
            body: formData
        });

        location.reload(); // refresh to show new picture
    });

    // Upload new background image
    document.getElementById("bg-input").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("file", file);

        await fetch("/api/upload/background", {
            method: "POST",
            body: formData
        });

        location.reload(); // refresh to show new background
    });
</script>

</body>
</html>
